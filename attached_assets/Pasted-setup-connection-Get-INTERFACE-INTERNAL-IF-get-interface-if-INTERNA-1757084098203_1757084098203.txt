setup_connection() {

    # Get INTERFACE
    INTERNAL_IF=$( get_interface )
    if [[ "$INTERNAL_IF" == "" ]]; then
        echo -e "${COLOR_ERROR}ERROR: could not find interface to card, please double check the card is connected${COLOR_END}"
        echo
        exit 2
    fi

    # Debug
    echo -e "${COLOR_INFO}Miromico ${MICROMICO_STRING} card detected using ${INTERNAL_IF}${COLOR_END}\n"
    
    # Identify interface by traffic
    EXTERNAL_IF=$( ip -o -4 route show to default | awk '{print $5}' )

    # Check if there is a miromico connection
    CONNECTION_EXISTS=$( ${NMCLI_CONNECTION_CMD} | grep -c ${CONNECTION_NAME} )

    if [[ $CONNECTION_EXISTS -eq 0 ]]; then
    sudo ${NMCLI_CONNECTION_CMD} add con-name ${CONNECTION_NAME} type ethernet
    fi

    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ifname "${INTERNAL_IF}"
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} connection.autoconnect yes
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ipv4.addresses 172.30.1.1/24
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ipv4.gateway 172.30.1.1
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ipv4.dns 1.1.1.1
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ipv4.method manual
    sudo ${NMCLI_CONNECTION_CMD} modify ${CONNECTION_NAME} ipv6.method ignore

    cat <<EOF > /tmp/99-${CONNECTION_NAME}
#!/usr/bin/env bash

INTERFACE=\$1
EVENT=\$2

if [[ "\$INTERFACE" = "$INTERNAL_IF" ]]
then

    ip route del default via 172.30.1.1
    echo 1 > /proc/sys/net/ipv4/ip_forward

    iptables-save  | grep -q "${CONNECTION_NAME}"
    if [[ \$? -eq 1 ]]
    then
        iptables -t filter -I FORWARD -i $INTERNAL_IF -j ACCEPT -m comment --comment "${CONNECTION_NAME}" 
        iptables -t nat -A PREROUTING -p udp --dport 53 -j DNAT --to-destination 1.1.1.1:53 -m comment --comment "${CONNECTION_NAME}"  
        iptables -t nat -A POSTROUTING -o $EXTERNAL_IF -j MASQUERADE -m comment --comment "${CONNECTION_NAME}" 
    fi

fi

exit 0

EOF

    sudo chown root:root /tmp/99-${CONNECTION_NAME}
    sudo chmod 755 /tmp/99-${CONNECTION_NAME}
    sudo mv /tmp/99-${CONNECTION_NAME} /etc/NetworkManager/dispatcher.d/

    sudo ${NMCLI_CONNECTION_CMD} reload

}
